# 项目性能优化

> 目标：
>
> - 了解应用性能问题分析方法论
> - 掌握压力测试基础概念：RT、TPS、Active Thread...
> - 掌握压力测试：线程组配置、结果分析，插件使用
> - 理解性能关键的指标
> - 掌握压测监控平台搭建
> - 了解分布式压力测试
> - 掌握Web服务容器优化：Tomcat调优，网络IO调优，及服务容器更换
> - 理解为什么进行数据库调优，以及数据库调优的调什么
> - 掌握OpenResty调优
> - 理解缓存调优和JVM调优必要性和价值点

## 1. 性能问题分析

**性能优化的终极目标：**

用户体验 = 产品设计(非技术) + 应用性能 ≈ 系统性能

应用性能是产品用户体验的基石，性能优化的终极目标是优化用户体验。

**应用性能调优的范围：**

- 后端：**RT、TPS**、并发数、Throughput、Footprint、Latency
  - TPS和RT的影响因素：数据库读写、RPC、网络IO、逻辑计算复杂度、JVM
- Web端：首屏时间、白屏时间、可交互时间、完全加载时间...
- 移动端：端到端响应时间、Crash率、内存使用率、FPS...


**影响性能的关键要素：**

- 产品设计：产品逻辑、功能交互、动态效果、页面元素
- 基础网络：网络 = 连接介质 + 计算终端
  - 连接介质：电缆、双绞线、光纤、微波、载波或通信卫星。
  - 计算终端：PC、手机、可穿戴设备、家具家电...
  - 基础网络设施，互联网，局域网(LAN)、城域网(MAN)、广域网(WAN)
- 代码质量&架构
  - 架构不合理 
  - 研发功底和经验不足
  - 没有性能意识：只实现了业务功能不注意代码性能，新功能上线后整体性能下降，或当业务上量后系统出现连锁反应，导致性能问题叠加，直接影响用户体验。
- 移动端环境
- 硬件及云服务

## 2. 压力测试

### 2.1 基础概念

**压力测试**（英语：Stress testing）是针对特定系统或是组件，为要确认其稳定性而特意进行的严格测试。会让系统在超过正常使用条件下运作，然后再确认其结果。

进行压力测试的目的可能包括：

1. 当负载逐渐增加时，观察**系统各项性能指标的变化情况**是否有异常
2. 发现系统的**性能短板**，进行针对性的性能优化
3. 判断系统在**高并发情况下是否会报错**，进程是否会挂掉
4. 测试在系统某个方面达到瓶颈时，粗略估计系统性能上限
5. ...

一般而言，只有在系统基础功能测试验证完成、系统趋于稳定的情况下，才会进行压测。

压测的性能指标：

![image-20231127223634001](项目性能优化.assets\image-20231127223634001.png)

性能指标的关联关系：

![image-20231127223725911](项目性能优化.assets\image-20231127223725911.png)

三条曲线：

- 吞吐量的曲线（紫色）
- 利用率（绿色）
- 响应时间曲线（深蓝色）

三个区域：

- 轻负载区（Light Load）
- 重负载区（Heavy Load）
- 塌陷区（Buckle Zone）

两个点：

- 最优并发用户数（The Optimum Number of Concurrent Users）
- 最大并发用户数（The Maximum Number of Concurrent Users）

三个状态描述：

- 资源饱和（Resource Saturated）
- 吞吐下降（Throughput Falling）
- 用户受影响（End Users Effected)

### 2.2 JMeter 的使用

Apache JMeter 可用于测试静态和动态资源、Web 动态应用程序的性能。它可用于模拟服务器、服务器组、网络或对象上的重负载，以测试其强度或分析不同负载类型下的整体性能。

![image-20231127224534834](项目性能优化.assets\image-20231127224534834.png)

1. 基本使用
2. 常用插件的使用
3. 性能关键指标分析
   - RT-响应时间
   - 压力机活动线程数
   - TPS-每秒的事务数
   - QPS-每秒的查询数
   - 吞吐量-每秒请求数量

服务器硬件资源监控：

- 使用操作系统命令：top、vmstat、iostat、iotop、dstat、sar...
- 使用finalshell
- 使用JMeter压测工具perfmon
- 使用Grafana+Prometheus+node_exporter

### 2.3 压测监控平台

![image-20231127225226117](项目性能优化.assets\image-20231127225226117.png)

Docker+JMeter+InfluxDB+Grafana+node_exporter

​					

### 2.4 梯度压测：分析接口性能瓶颈

**（1）配置信息**

压测配置：

**情况01-模拟低延时场景**，用户访问接口并发逐渐增加的过程。预计接口的响应时间为20ms

- 线程梯度：5、10、15、20、25、30、35、40个线程
- 循环请求次数5000次
- 时间设置：Ramp-up period(inseconds)的值设为对应线程数
- 测试总时长：约等于20ms x 5000次 x 8 = 800s = 13分
- 配置断言：超过3s，响应状态码不为20000，则为无效请求

机器环境：

- 应用服务器配置：4C8G
- 外网-网络带宽25Mbps （峰值）
- 内网-网络带宽基础1.5/最高10Gbit/s
- 集群规模：单节点
- 服务版本：v1.0
- 数据库服务器配置：4C8G

配置监听器：

1. 聚合报告：添加聚合报告
2. 查看结果树：添加查看结果树
3. 活动线程数：压力机中活动的线程数
4. TPS统计分析：每秒事务树
5. RT统计分析：响应时间
6. 后置监听器，将压测信息汇总到InfluxDB，在Grafana中呈现
7. 压测监控平台：
   - JMeter DashBoard
   - 应用服务器：内存、网络、磁盘、系统负载情况
   - MySQL服务器：内存、网络、磁盘、系统负载情况

**（2）性能瓶颈剖析**

结果：

发现问题：

问题1：网络到达瓶颈

问题2：接口的响应时间是否正常？是不是所有的接口响应都可以这么快？

问题3：TPS在上升到一定的值之后，异常率较高

## 2.5 分布式压测

使用JMeter做大并发压力测试的场景下，单机受限与内存、CPU、网络IO，会出现服务器压力还没有上去，但是压测机压力太大已经死机！为了让JMeter拥有更强大的负载能力，JMeter提供分布式压测能力。

- 单机网络带宽有限
- 高延时场景下，单机可模拟最大线程数有限

如下是分布式压测架构：

![image-20231128214018098](01-项目性能优化.assets\image-20231128214018098.png)

## 3. 服务容器优化

- Tomcat 调优
- 网络 IO 模型调优
- 容器优化 Tomcat 升级 Undertow

## 4 数据库调优

- ...

## 5. OpenResty 调优

https://openresty.org/cn/

## 6. 缓存调优

- ...

## 7. JVM 调优

- ...

